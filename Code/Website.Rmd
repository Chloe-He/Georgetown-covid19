---
title: "Has public policy flatten the curve?"
output: 
  flexdashboard::flex_dashboard:
params:
  wd_path:
    label: Set the directory path
    value: ~/Desktop/georgetown_project/
  output_path:
    label: Set the output files path
    value: ~/Desktop/georgetown_project/deliverables/
  policy_file_name:
    label: Path to the policy data file
    value: ~/Desktop/georgetown_project/cleaner.csv
  cases_file_name:
    label: Path to the pheno data file
    value: ~/Desktop/georgetown_project/county_case_with_TWdailyR0_2020-04-24.csv
---

```{r setup, include=FALSE}
library(flexdashboard)
```


Analysis Approach
=====================================  
Analysis Approach {data-width=500}
-----------------------------------------------------------------------

### Analysis Plan
***
Our goal is to determine whether physical social distancing will decrease the rate of spread of COVID-19. We look at social distancing from two perspetctives: lock-down/shelter-in-place and gathering restriction. For each, we studied the effect on transmission rate reduction, and we define transmission rate as effective reproductive number (Re). 

More specifically,

$Re(u)= \sum_{s=today}^{today+stop}\frac{b(s)g(s-today)}{\sum_{a=0}^{stop}b(s-a)g(a)}$


"According to Wallinga and Lipstich, The reproductive number to the time t at could be find by summing over all possible times t"


$\sum_{s=t}^{t+stop}$: look ahead starting today through t+stop day


$R(t)$: the effective reproductive number today (t)


$b(t)$: incidence number at time t


$g(t)$: value for general interval distribution at time t (the generation interval distribution is the probability distribution function for the time from infection of an individual to the infection of a secondary case by that individual)


stop: max generation interval as first day that captures $>$ 99\% of the density


In epidemiology, the basic reproductive number Re is often computed to quantify the intensity of an outbreak. R0 could be intuitively thought of the expected number of infectees directly generated by one infector in a population where all individuals are susceptible to be infected. However, in the context of COVID-19, we don’t assume that everyone is susceptible, thus a daily effective reproductive number is useful

Rest of the analysis is organized as follows.

In tab 2, we visually determine whether gathering restriction decreases daily Re or not. 

In tab 3, we study the effect of lockdown on Re.

Percentage change of effective reproductive number 4 days after lock-down policy is imposed and number of days needed for the policy to be effective is studied in tab 4. We compare Re on the day lock-down policy is placed and that of 4 days after to test whether there is an immediate effect of policy on Re. We can observe that the daily effective reproductive number is mostly between 1 and 2. Hence, decreasing the rate by $50\%$ would considerably mitigate the spread of the virus. Therefore, we calculated number of days needed for Re to decrease by $50\%$.

Finally, we conclude with a brief discussion in Tab 5.

###Participants
Shan He

Harvard University, MS in Biostatistics

she@hsph.harvard.edu

Kyung Serk Cho

Columbia University, MA in Statistics

kc3313@columbia.edu


```{r}
library(lubridate)
library(ggplot2)
```


Analysis Approach {data-width=500}
-----------------------------------------------------------------------

### Reproduction Number of Distribution by States
```{r}
# this is only daily_ro in different county
df_new <- read.csv("~/Desktop/georgetown_project/county_case_with_TWdailyR0_2020-04-24.csv",header=T)
df_new$daily_r = as.numeric(df_new$daily_r)
temp = aggregate(df_new$daily_r,by=list(df_new$state),FUN=mean)

#plot(unique(df_new$state),temp[,2],main="Average Daily effective reproductive number for US states",xlab="States in alphabetical orders",ylab="Daily R0",ylim=c(0.9,2))
#abline(h=1,col="red")
ggplot(temp, aes(unique(df_new$state), temp[,2])) +
    geom_point(data = temp, aes(y = x), size = 2)+
    theme(axis.text.x=element_text(angle=90,size=7))+
    ggtitle("Average Daily effective reproductive number for US states")+
    xlab("US State")+
    ylab("Average Daily Re")

```

### Confirmed cases over time in the US

```{r}

df_new$date = mdy(df_new$date)
temp2 = aggregate(df_new$case,by=list(df_new$date),FUN=sum)

ggplot(temp2, aes(temp2[,1], temp2[,2])) +
    geom_point(data = temp2, aes(y = x), size = 2)+
    theme(axis.text.x=element_text(angle=90,size=5))+
    ggtitle("Confirmed Covid-19 Cases over time in the US")+
    xlab("Date")+
    ylab("Confirmed Cases")
    
```


The impact of Gathering Restriction
=====================================  

```{r}

df_new = read.csv("~/Desktop/georgetown_project/aa.csv",header=T)
number_of_state = length(unique(df_new$State))

for (i in 1:number_of_state){
  subset = subset(df_new,df_new$State==unique(df_new$State)[i])
  subset$gather = as.factor(subset$gather)
  p = ggplot(subset, aes(Date, Daily_R0)) +
    geom_point(data = subset, aes(y = Daily_R0), size = 3)+
    theme(axis.text.x=element_text(angle=90,size=7))+
    ggtitle(paste0("COVID-19 Effective Reproduction Number over time for ",subset$State[1]))+
    geom_point(aes(colour=factor(gather)))+
    labs(colour = "Gathering Restriction", size = 8)
    g <- p+ scale_color_manual(name= "Gathering Restriction",labels=c("No Gathering Restriction","Gathering of 1000 people","Gathering of 500 people","Gathering of 250 people","Gathering of 100 people","Gathering of 50 people","Gathering of 25 people","Gathering of 10 people","Gathering of 5 people","Gathering of Anyone"),values = c("0" = "salmon4","1" ="plum4" ,"2"="lightpink4","3"="red", "4"="orange4","5"="orange","6"="palegreen4","7"="paleturquoise4","8"="steelblue4","9" = "skyblue4")) + labs(y ="Daily Re")
  print(g)
}
```

The impact of Lockdown
=====================================  
```{r}
df_new = read.csv("~/Desktop/georgetown_project/aa.csv",header=T)
number_of_state = length(unique(df_new$State))
#p <- list()
for (i in 1:number_of_state){
  subset = subset(df_new,df_new$State==unique(df_new$State)[i])
  subset$gather = as.factor(subset$gather)
  p = ggplot(subset, aes(Date, Daily_R0)) +
    geom_point(data = subset, aes(y = Daily_R0), size = 3)+
    theme(axis.text.x=element_text(angle=90,size=7))+
    ggtitle(paste0("COVID-19 Effective Reproduction Number over time for ",subset$State[1]))+
    geom_point(aes(colour=factor(lockdown)))+
    labs(colour = "Shelter-in-Place")
  g <- p+ scale_color_manual(name= "Shelter-in-Place",labels=c("No Lock-down","Lock-down"),values = c("0" = "blue", "1" = "red")) + labs(y ="Daily Re")
  print(g)
}
```

Effect of Lockdown
=====================================  
Column 
-------------------------------------
###Is lockdown order immediately effective? {.storyboard}

```{r}
df_new <- read.csv("~/Desktop/georgetown_project/df_new.csv",header=T)
df_new$change.pct <- 0
df_new$change <- 0
number_of_states = length(unique(df_new$State))
df_new$Date = as.Date(df_new$Date)
for (i in (1:number_of_states)){  
  df_new[which(df_new$State==unique(df_new$State)[i]),]$change =
    ifelse(df_new[df_new$State==unique(df_new$State)[i],]$lockdown == 1,
            df_new[which(df_new$State==unique(df_new$State)[i] 
                 & df_new$lockdown == 1 
                 & df_new$Date== df_new[which(df_new$State==unique(df_new$State)[i] & df_new$lockdown == 1),]$Date[1] +5),]$Daily_R0[1]
   -df_new[which(df_new$State==unique(df_new$State)[i] & df_new$lockdown == 1),]$Daily_R0[1]
   ,0)
 df_new[which(df_new$State==unique(df_new$State)[i]),]$change.pct =
    ifelse(df_new[df_new$State==unique(df_new$State)[i],]$lockdown == 1,
   (df_new[which(df_new$State==unique(df_new$State)[i] 
                 & df_new$lockdown == 1 
                 & df_new$Date== df_new[which(df_new$State==unique(df_new$State)[i] 
                 & df_new$lockdown == 1),]$Date[1] +5),]$Daily_R0[1]- df_new[which(df_new$State==unique(df_new$State)[i] & df_new$lockdown == 1),]$Daily_R0[1])/df_new[which(df_new$State==unique(df_new$State)[i] & df_new$lockdown == 1),]$Daily_R0[1] * 100
   ,0)
}

df_new$change.pct <- as.numeric(df_new$change.pct)


change.pct <- unique(df_new$change.pct)[-1]
change_data <- data.frame(change.pct)

ggplot(change_data, aes(x=unique(change.pct)))+geom_histogram(color="darkblue", fill="lightblue",  bins = 10)+labs(title= "Percentage Change in Re 4 days after lockdown",y="Count", x="Percentage of Change")

```

Column 
-------------------------------------

###So...is Lockdown necessary?


```{r}
df_new$R0.req <- 0
df_new$days.req <- 0

for (i in (1:number_of_states)){  
  df_new[df_new$State==unique(df_new$State)[i],]$R0.req =
    ifelse( df_new[df_new$State==unique(df_new$State)[i],]$lockdown ==1, df_new[which(df_new$State==unique(df_new$State)[i]&df_new$lockdown==1)[1],]$Daily_R0*0.5 ,0)
}

for (i in (1:number_of_states)){  
  df_new[df_new$State==unique(df_new$State)[i],]$days.req =
    ifelse(df_new[df_new$State==unique(df_new$State)[i],]$Daily_R0 <= df_new[df_new$State==unique(df_new$State)[i],]$R0.req,
as.numeric(df_new[which(df_new$State==unique(df_new$State)[i] & df_new$Daily_R0 <= df_new$R0.req & df_new$lockdown == 1)[1],]$Date) -as.numeric(df_new[which(df_new$State==unique(df_new$State)[i] & df_new$lockdown == 1)[1],]$Date),0)
}

for (i in (1:number_of_states)){  
  df_new[df_new$State==unique(df_new$State)[i],]$days.req =
    ifelse(which(df_new[df_new$State==unique(df_new$State)[i],]$Daily_R0 <= df_new[df_new$State==unique(df_new$State)[i],]$R0.req)[1],
as.numeric(df_new[which(df_new$State==unique(df_new$State)[i] & df_new$Daily_R0 <= df_new$R0.req & df_new$lockdown == 1)[1],]$Date) -as.numeric(df_new[which(df_new$State==unique(df_new$State)[i] & df_new$lockdown == 1)[1],]$Date),0)
}

days_needed = 0
for (i in (1:number_of_states)){ 
  days_needed = cbind(days_needed,df_new[which(df_new$State==unique(df_new$State)[i]),]$days.req[1])
}
days_needed = days_needed[-1]
days_data <- data.frame(days_needed)

ggplot(days_data, aes(x=days_needed))+geom_histogram(color="darkblue", fill="lightblue",  bins = 15, na.rm = TRUE) +labs(title= "Number of Days needed for lock down to be effective",y="Count", x="Number of Days needed to reduce Re by 50%")
```

Conclusion
=====================================  
Row
-------------------------------------
 
###Conclusion

From tab 2, we can see that gathering restriction policies decreased daily Re. Especially, in many states, restricting gathering of 500 people reduced the transmission rate.

From tab 3, we determined that lock-down policy can reduce daily Re.

In tab 4, we studied the effect of shelter-in-place more closely. We concluded that 4 days after the policy is inacted, it has an immediate effect on Re. However, immediate effect is not enough. Hence, we looked at how many days needed for the policy to be effective. We concluded that at least 10 days is needed for lock-down policy to be effective.

To conclude, we believe public policy related to social distancing flattens the curve. However, immediate effect of the policy is not significant and it takes between 10 and 30 days for the policy to be effective.

Row
-------------------------------------
###Citation

J. Wallinga, M. Lipsitch, How generation intervals shape the relationship between growth rates and reproductive numbers. Proc. R. Soc. B Biol. Sci. 274, 599–604 (2007).
